name: Pars iOS Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app || sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Session.xcodeproj \
            -scheme Session

      - name: Build (Simulator)
        run: |
          xcodebuild build \
            -project Session.xcodeproj \
            -scheme Session \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.VERSION }}
          name: "Pars iOS ${{ steps.version.outputs.VERSION }}"
          body: |
            ## Pars Messenger iOS ${{ steps.version.outputs.VERSION }}

            ### Installation Options

            **Option 1: Build from Source** (Recommended)
            ```bash
            git clone https://github.com/parsdao/pars-ios
            cd pars-ios
            open Session.xcodeproj
            ```
            Then in Xcode: Change Team → Connect device → Build (Cmd+R)

            **Option 2: AltStore**
            Use [AltStore](https://altstore.io/) to sideload with your Apple ID.

            **Option 3: TestFlight** (Coming Soon)
            Join waitlist at [pars.network](https://pars.network)

            ### Why No IPA Download?
            Apple requires all iOS apps to be signed. Without an Apple Developer certificate in CI, we cannot produce installable IPAs. See README for details.

            ### Build Status
            ✅ Compiles successfully on Xcode 16.2
          draft: true
          allowUpdates: true
